name: Build and Push to RunPod

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: false
          tags: moda-ai-studio:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Test Docker image
        run: |
          docker run -d -p 8080:80 --name test-container moda-ai-studio:latest
          echo "Waiting for container to be ready..."
          for i in {1..30}; do
            if curl -f http://localhost:8080 > /dev/null 2>&1; then
              echo "Container is ready!"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "Container failed to start within 30 seconds"
              docker logs test-container
              exit 1
            fi
            sleep 1
          done
          docker stop test-container
          docker rm test-container

      - name: Deployment Instructions
        run: |
          echo "âœ… Docker image built successfully!"
          echo ""
          echo "ðŸ“¦ To deploy to RunPod.io:"
          echo "1. Connect your GitHub repository to RunPod"
          echo "2. Go to RunPod Console > Serverless > New Endpoint"
          echo "3. Select 'Import Git Repository' and choose this repo"
          echo "4. RunPod will automatically detect and build the Dockerfile"
          echo "5. Configure your endpoint settings (name, resources, etc.)"
          echo "6. Deploy!"
          echo ""
          echo "ðŸ“š See README.md for detailed deployment instructions"
